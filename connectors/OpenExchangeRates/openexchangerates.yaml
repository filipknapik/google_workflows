

latestOpenExchangeRates:
    params: [secret, base: USD, prettyprint: FALSE, show_alternative: FALSE, symbols: ""]
    steps:
      - getSecret:
          call: http.get
          args:
              url: ${"https://secretmanager.googleapis.com/v1/projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_NUMBER") + "/secrets/" + secret + "/versions/latest:access"}
              auth:
                  type: OAuth2
          result: sendGridKey
      - decodeSecrets:
          assign:
            - decodedKey: ${text.decode(base64.decode(sendGridKey.body.payload.data))}
      - getLatestCurrencies:
          call: http.get
          args:
              url: https://openexchangerates.org/api/latest.json
              headers: 
                  Authorization: ${"Token " + decodedKey}
              query:
                  base: ${base}
                  prettyprint: ${prettyprint}
                  show_alternative: ${show_alternative}
                  symbols: ${symbols}
          result: latestCurrencies
      - returnValue:
          return: ${latestCurrencies}

timeSeriesOpenExchangeRates:
    params: [secret, start, end, base: USD, prettyprint: FALSE, show_alternative: FALSE, symbols: ""]
    steps:
      - getSecret:
          call: http.get
          args:
              url: ${"https://secretmanager.googleapis.com/v1/projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_NUMBER") + "/secrets/" + secret + "/versions/latest:access"}
              auth:
                  type: OAuth2
          result: sendGridKey
      - decodeSecrets:
          assign:
            - decodedKey: ${text.decode(base64.decode(sendGridKey.body.payload.data))}
      - getLatestCurrencies:
          call: http.get
          args:
              url: https://openexchangerates.org/api/time-series.json
              headers: 
                  Authorization: ${"Token " + decodedKey}
              query:
                  base: ${base}
                  prettyprint: ${prettyprint}
                  show_alternative: ${show_alternative}
                  symbols: ${symbols}
                  start: ${start}
                  end: ${end}
          result: latestCurrencies
      - returnValue:
          return: ${latestCurrencies}